# 微信助手机器人项目计划书

## 1. 项目概述

### 1.1 项目名称
微信AI助手（基于智谱GLM大模型）

### 1.2 项目目标
创建一个基于微信的AI助手机器人，通过智谱GLM大模型提供智能对话服务。

### 1.3 技术栈
- **后端框架**: FastAPI (Python)
- **AI模型**: 智谱GLM大模型
- **微信接入**: 微信公众平台测试号
- **部署服务器**: 121.43.195.232

## 2. 项目架构

```
┌─────────────┐
│  微信用户    │
└──────┬──────┘
       │
       │ 微信消息
       ▼
┌─────────────────────┐
│  微信公众平台       │
│  (测试号)           │
└──────┬──────────────┘
       │ POST请求
       │
       ▼
┌─────────────────────────────────┐
│         微信机器人服务器         │
│                                 │
│  ┌──────────────────────────┐  │
│  │   FastAPI Web服务       │  │
│  │                          │  │
│  │  - 微信消息验证处理       │  │
│  │  - 消息解析              │  │
│  │  - 响应生成              │  │
│  └──────────┬───────────────┘  │
│             │                    │
│             ▼                    │
│  ┌──────────────────────────┐  │
│  │    消息处理器            │  │
│  └──────────┬───────────────┘  │
│             │                    │
│             ▼                    │
│  ┌──────────────────────────┐  │
│  │   智谱GLM客户端          │  │
│  │   (调用AI模型)           │  │
│  └──────────┬───────────────┘  │
│             │                    │
└─────────────┼────────────────────┘
              │
              ▼
       ┌──────────────┐
       │  智谱AI API  │
       └──────────────┘
```

## 3. 功能模块

### 3.1 核心功能（第一阶段）

| 功能模块 | 描述 | 优先级 |
|---------|------|--------|
| 微信接入 | 实现微信服务器验证和消息接收/回复 | P0 |
| AI对话 | 调用智谱GLM模型生成回复 | P0 |
| 消息处理 | 解析微信消息格式，处理文本/图片等 | P0 |
| 错误处理 | API调用失败、超时等异常处理 | P0 |

### 3.2 增强功能（第二阶段）

| 功能模块 | 描述 | 优先级 |
|---------|------|--------|
| 日志管理 | 记录用户对话、API调用、错误日志 | P1 |
| 消息持久化 | 将对话记录存储到数据库 | P1 |
| 用户管理 | 识别不同用户，维护对话上下文 | P1 |
| 多轮对话 | 记录历史对话，实现连续对话 | P1 |

### 3.3 扩展功能（第三阶段）

| 功能模块 | 描述 | 优先级 |
|---------|------|--------|
| 命令系统 | 支持/help、/clear等命令 | P2 |
| 图片识别 | 支持图片输入和多模态回复 | P2 |
| 语音识别 | 支持语音消息转文字 | P2 |
| 管理后台 | Web界面管理对话历史 | P2 |

## 4. 目录结构

```
WXzhushou/
├── main.py                 # 应用入口
├── config.py               # 配置文件
├── requirements.txt        # 依赖包列表
├── README.md              # 项目说明文档
├── .env                   # 环境变量（敏感信息）
│
├── app/
│   ├── __init__.py
│   ├── server.py          # FastAPI服务器
│   └── routers/
│       └── wechat.py      # 微信相关路由
│
├── services/
│   ├── __init__.py
│   ├── wechat_service.py  # 微信消息处理服务
│   └── ai_service.py      # AI对话服务
│
├── models/
│   ├── __init__.py
│   └── message.py         # 消息数据模型
│
├── utils/
│   ├── __init__.py
│   ├── logger.py          # 日志工具
│   └── crypto.py          # 加密工具
│
├── data/
│   └── logs/              # 日志目录
│
└── tests/
    ├── __init__.py
    └── test_wechat.py     # 单元测试
```

## 5. 配置说明

### 5.1 环境变量配置 (.env)

```env
# 微信测试号配置
WECHAT_APP_ID=your_app_id
WECHAT_APP_SECRET=your_app_secret
WECHAT_TOKEN=your_token
WECHAT_ENCODING_AES_KEY=your_encoding_aes_key

# 智谱AI配置
ZHIPU_API_KEY=f9442f7d070445139baf609ad21fca3b.OjXUCTYAziRnzM7l
ZHIPU_API_URL=https://open.bigmodel.cn/api/paas/v4/chat/completions

# 服务器配置
SERVER_HOST=0.0.0.0
SERVER_PORT=8000

# 日志配置
LOG_LEVEL=INFO
LOG_FILE=data/logs/app.log
```

### 5.2 服务器配置

- **IP地址**: 121.43.195.232
- **端口**: 8000 (可配置)
- **外网URL**: http://121.43.195.232:8000

## 6. 微信测试号接入步骤

1. **获取微信测试号**
   - 访问微信公众平台: https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login
   - 使用微信扫码登录获取测试号信息

2. **配置服务器信息**
   - URL: http://121.43.195.232:8000/wechat
   - Token: 自定义字符串（需与服务器配置一致）
   - EncodingAESKey: 随机生成

3. **配置项目环境变量**
   - 将获取的 appID 和 appsecret 填入 .env 文件

## 7. 开发计划

### 第一阶段：基础功能开发

| 任务 | 状态 | 预计时间 |
|-----|------|---------|
| 项目初始化 | 待开始 | - |
| 配置微信验证接口 | 待开始 | - |
| 实现消息接收与回复 | 待开始 | - |
| 集成智谱GLM API | 待开始 | - |
| 基础对话功能测试 | 待开始 | - |

### 第二阶段：日志与管理

| 任务 | 状态 | 预计时间 |
|-----|------|---------|
| 实现日志系统 | 待开始 | - |
| 对话记录存储 | 待开始 | - |
| 用户上下文管理 | 待开始 | - |

### 第三阶段：功能扩展

| 任务 | 状态 | 预计时间 |
|-----|------|---------|
| 命令系统开发 | 待开始 | - |
| 图片识别支持 | 待开始 | - |
| 管理后台开发 | 待开始 | - |

## 8. 技术要点

### 8.1 微信服务器验证
微信服务器会发送GET请求进行验证，需要按规则返回echostr参数

### 8.2 消息加解密
微信消息可能需要AES加密处理（开发模式默认使用明文模式）

### 8.3 异步处理
使用async/await处理AI调用，避免阻塞微信响应

### 8.4 消息响应限制
- 微信被动回复消息限制：5秒内响应
- AI调用可能较慢，需要考虑超时处理

## 9. 部署方案

### 9.1 服务器环境要求
- Python 3.8+
- 允许外网访问（需要开放8000端口）

### 9.2 部署步骤
1. 上传代码到服务器
2. 安装依赖：`pip install -r requirements.txt`
3. 配置环境变量：`.env` 文件
4. 启动服务：`python main.py`
5. 使用pm2或systemd实现进程守护

### 9.3 防火墙配置
```bash
# 开放8000端口
sudo ufw allow 8000
```

## 10. 注意事项

1. **API密钥安全**: 不要将敏感信息提交到代码仓库
2. **消息响应时间**: 微信要求5秒内响应，AI调用可能较慢
3. **频率限制**: 智谱API有调用频率限制，需要处理
4. **服务器稳定性**: 使用进程守护工具防止服务意外停止
5. **日志记录**: 记录关键信息便于问题排查

## 11. 后续优化方向

- 添加对话历史记忆功能
- 实现多用户隔离
- 支持更多消息类型（图片、语音等）
- 添加用户画像和个性化推荐
- 实现Web管理界面

---

**文档版本**: v1.0
**创建日期**: 2026-02-10
