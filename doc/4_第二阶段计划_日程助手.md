# 微信AI助手 - 第二阶段开发计划

> **阶段名称**: 功能增强 - 日程助手
> **创建日期**: 2026-02-11
> **预计周期**: 2-3周
> **目标**: 为AI助手添加日程管理功能

---

## 📋 需求概述

为微信AI助手添加智能日程管理功能，用户可以通过自然语言创建、查询、管理日程，系统会在指定时间提醒用户。

### 核心功能
- 📅 创建日程（自然语言）
- 🔍 查询日程
- ✏️ 修改/删除日程
- ⏰ 定时提醒
- 📊 日程列表展示

---

## 🎯 用户场景

### 场景1：创建日程
```
用户: 明天下午3点提醒我开会
AI: 好的，我已为您创建日程：
    时间：明天 15:00
    内容：开会
```

### 场景2：查询日程
```
用户: 我明天有什么安排？
AI: 您明天有以下安排：
    15:00 - 开会
```

### 场景3：删除日程
```
用户: 删除明天下午的会议
AI: 好的，已为您删除明天15:00的"开会"日程
```

### 场景4：定时提醒
```
系统: (明天15:00推送) ⏰ 提醒：您现在有会议 - 开会
```

---

## 🏗️ 技术架构

### 架构设计

```
┌─────────────┐         ┌─────────────┐         ┌─────────────┐
│  微信用户    │ ───────▶│  微信服务器  │ ───────▶│  我们的服务器 │
└─────────────┘         └─────────────┘         └─────────────┘
                                                         │
                                                         ▼
                                                 ┌─────────────┐
                                                 │   AI引擎    │
                                                 │  (GLM-4)    │
                                                 └─────────────┘
                                                         │
                                                         ▼
                                                 ┌─────────────┐
                                                 │  意图识别   │
                                                 │  参数提取   │
                                                 └─────────────┘
                                                         │
                        ┌────────────────────────────────┼────────────────┐
                        ▼                                ▼                ▼
                ┌─────────────┐                ┌─────────────┐   ┌─────────────┐
                │  日程管理   │                │  任务调度   │   │   数据库    │
                │  Service    │                │  Scheduler  │   │  Database   │
                └─────────────┘                └─────────────┘   └─────────────┘
```

---

## 🛠️ 技术选型

### 数据层

| 组件 | 技术选型 | 说明 |
|------|----------|------|
| 数据库 | **SQLite** | 轻量级，无需额外服务 |
| ORM | **SQLAlchemy** | Python主流ORM |
| 迁移工具 | **Alembic** | 数据库版本管理 |

**选择理由**:
- SQLite轻量级，部署简单，适合中小规模
- 后续可平滑迁移到PostgreSQL

### 任务调度

| 组件 | 技术选型 | 说明 |
|------|----------|------|
| 调度器 | **APScheduler** | Python强大的定时任务库 |
| 触发器 | CronTrigger | 支持灵活的时间表达式 |
| 存储后端 | SQLAlchemyJobStore | 任务持久化到数据库 |

**选择理由**:
- APScheduler功能强大，支持持久化
- 支持多种触发器类型
- 与FastAPI集成简单

### AI理解层

| 功能 | 技术方案 | 说明 |
|------|----------|------|
| 意图识别 | **LLM Function Calling** | 使用GLM函数调用功能 |
| 时间解析 | **dateparser + 正则** | 中文时间表达式解析 |
| 实体提取 | **LLM + 规则** | 混合方案，准确率高 |

---

## 📁 项目结构

```
WXzhushou/
├── main.py
├── config.py
│
├── app/
│   ├── server.py
│   └── routers/
│       ├── wechat.py
│       └── schedule.py      # 新增：日程管理接口
│
├── services/
│   ├── ai_service.py
│   ├── wechat_service.py
│   └── schedule_service.py  # 新增：日程业务逻辑
│
├── models/
│   ├── message.py
│   └── schedule.py          # 新增：日程数据模型
│
├── utils/
│   ├── logger.py
│   ├── crypto.py
│   ├── time_parser.py       # 新增：时间解析工具
│   └── scheduler.py         # 新增：任务调度器
│
├── database/                # 新增：数据库目录
│   ├── __init__.py
│   ├── base.py              # 数据库基类
│   ├── session.py           # 数据库会话管理
│   └── migrations/          # Alembic迁移文件
│       └── versions/
│
└── doc/
    ├── 1_PROJECT_ARCHIVE.md
    ├── 2_PROJECT_PLAN.md
    ├── 3_SERVER_DEV_GUIDE.md
    └── 4_PHASE2_PLAN.md     # 本文档
```

---

## 💾 数据模型设计

### schedules 表

```sql
CREATE TABLE schedules (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id VARCHAR(100) NOT NULL,           -- 微信用户ID
    title VARCHAR(200) NOT NULL,             -- 日程标题
    description TEXT,                         -- 详细描述
    scheduled_time DATETIME NOT NULL,        -- 日程时间
    remind_before INTEGER DEFAULT 0,         -- 提前提醒分钟数
    status VARCHAR(20) DEFAULT 'active',     -- 状态：active/completed/cancelled
    job_id VARCHAR(100),                     -- APScheduler任务ID
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP,                  -- 完成时间
    INDEX idx_user_time (user_id, scheduled_time),
    INDEX idx_status (status)
);
```

### schedule_logs 表

```sql
CREATE TABLE schedule_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    schedule_id INTEGER NOT NULL,
    action VARCHAR(50) NOT NULL,             -- create/update/delete/complete/remind
    details TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (schedule_id) REFERENCES schedules(id)
);
```

---

## 🤖 AI意图设计

### Function Calling Schema

```json
{
  "functions": [
    {
      "name": "create_schedule",
      "description": "创建一个新的日程",
      "parameters": {
        "type": "object",
        "properties": {
          "title": {
            "type": "string",
            "description": "日程标题"
          },
          "datetime": {
            "type": "string",
            "description": "日程时间，如：明天下午3点、2024-02-12 15:00"
          },
          "description": {
            "type": "string",
            "description": "日程详细描述"
          },
          "remind_before": {
            "type": "integer",
            "description": "提前多少分钟提醒"
          }
        },
        "required": ["title", "datetime"]
      }
    },
    {
      "name": "query_schedules",
      "description": "查询用户的日程",
      "parameters": {
        "type": "object",
        "properties": {
          "date": {
            "type": "string",
            "description": "查询日期，如：今天、明天、本周"
          }
        }
      }
    },
    {
      "name": "delete_schedule",
      "description": "删除指定日程",
      "parameters": {
        "type": "object",
        "properties": {
          "schedule_id": {
            "type": "integer",
            "description": "要删除的日程ID"
          }
        },
        "required": ["schedule_id"]
      }
    },
    {
      "name": "update_schedule",
      "description": "更新日程信息",
      "parameters": {
        "type": "object",
        "properties": {
          "schedule_id": {
            "type": "integer",
            "description": "要更新的日程ID"
          },
          "title": {
            "type": "string",
            "description": "新的日程标题"
          },
          "datetime": {
            "type": "string",
            "description": "新的日程时间"
          }
        },
        "required": ["schedule_id"]
      }
    }
  ]
}
```

---

## 🔄 开发计划

### 第1周：基础架构搭建

**目标**: 完成数据层和基础服务

#### Day 1-2: 数据库设计
- [ ] 设计数据库模型
- [ ] 配置SQLAlchemy
- [ ] 创建数据库表
- [ ] 编写数据访问层（CRUD）

#### Day 3-4: 时间解析工具
- [ ] 集成dateparser
- [ ] 编写中文时间表达式解析
- [ ] 处理相对时间（明天、下周等）
- [ ] 单元测试

#### Day 5-7: 日程服务
- [ ] 实现日程CRUD逻辑
- [ ] 实现查询功能（按日期、状态）
- [ ] 编写服务层单元测试

---

### 第2周：AI集成与任务调度

**目标**: 实现智能识别和定时提醒

#### Day 1-3: AI意图识别
- [ ] 定义Function Calling Schema
- [ ] 实现意图路由逻辑
- [ ] 提取日程参数
- [ ] 错误处理和用户友好提示

#### Day 4-5: 任务调度器
- [ ] 配置APScheduler
- [ ] 实现任务添加/删除
- [ ] 实现任务持久化
- [ ] 处理任务失败重试

#### Day 6-7: 微信消息推送
- [ ] 实现定时提醒推送
- [ ] 测试提醒到达率
- [ ] 优化推送内容

---

### 第3周：功能完善与测试

**目标**: 完善功能、修复bug、优化体验

#### Day 1-2: 功能完善
- [ ] 日程列表展示优化
- [ ] 支持日程修改
- [ ] 支持日程取消
- [ ] 添加快捷命令

#### Day 3-4: 用户体验优化
- [ ] 优化AI回复话术
- [ ] 添加操作确认
- [ ] 错误提示友好化
- [ ] 支持自然语言模糊查询

#### Day 5-7: 测试与部署
- [ ] 功能测试
- [ ] 压力测试
- [ ] 服务器部署
- [ ] 文档更新

---

## 📝 依赖更新

### requirements.txt 新增

```txt
# 数据库
sqlalchemy==2.0.23
alembic==1.13.0

# 任务调度
apscheduler==3.10.4

# 时间解析
dateparser==1.2.0
zhon==2.0.1              # 中文字符处理
```

---

## 🔐 环境变量新增

```env
# 数据库配置
DATABASE_URL=sqlite:///data/schedules.db

# 任务调度配置
SCHEDULER_TIMEZONE=Asia/Shanghai
SCHEDULER_MAX_WORKERS=3
```

---

## 📊 API接口设计

### 新增接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/schedules` | GET | 获取用户日程列表 |
| `/api/schedules` | POST | 创建新日程 |
| `/api/schedules/{id}` | PUT | 更新日程 |
| `/api/schedules/{id}` | DELETE | 删除日程 |
| `/api/schedules/upcoming` | GET | 获取即将到来的日程 |

---

## 🎨 用户体验设计

### 对话流程

```
用户: 帮我记一下，后天上午10点要去医院
AI: 好的，我来帮您创建日程：

    📅 新建日程
    时间：后天 10:00
    内容：去医院

    请确认是否创建？

用户: 确认
AI: ✅ 日程创建成功！我会在后天10点提醒您。

    （可选：需要提前多少分钟提醒您？）
```

### 提醒推送

```
⏰ 日程提醒

您有一个日程即将开始：

📅 时间：后天 10:00
📝 内容：去医院

请做好准备！
```

---

## ⚠️ 注意事项

1. **时区处理**: 统一使用Asia/Shanghai时区
2. **任务持久化**: 服务重启后任务不丢失
3. **并发控制**: 避免重复创建相同日程
4. **消息限流**: 避免微信接口频率限制
5. **数据备份**: 定期备份日程数据

---

## 🚀 后续扩展

- 📊 数据统计分析
- 🔄 日程重复（每天、每周）
- 👥 多用户日程共享
- 📅 日历同步（Google Calendar、Outlook）
- 🎨 丰富的日程类型（生日、纪念日）

---

**文档版本**: v1.0.0
**创建日期**: 2026-02-11
**最后更新**: 2026-02-11
